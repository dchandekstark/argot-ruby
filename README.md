# Argot : a Ruby gem for TRLN shared discovery ingest processes

This gem provides libraries and command-line utilities for working with Argot, the ingest format for
the TRLN shared index.

# Installation

Start with

    $ bundle install

(as long as you have the `bundler` gem available) will install all the dependencies. then


    $ rake spec

or even just

    $ rake

Will run the tests.

    $ rake install 
    
will install the gem.

This gem is supported under both MRI and JRuby, but for small input files especially, MRI is likely to be faster.  No optimizations are yet in place to
take advantage of multithreading under JRuby.

## Usage 

### As Library
```ruby

require 'json' # only required for the example
require 'argot'

# new reader for processing files in the Argot format
# with default validator using rules in  `lib/data/rules.yml`
# with default error handler that writes bad records and the error report
# to stdout

File.open("nccu-2015101201320.json") do |f|
    reader = Argot::Reader.new(f)
    File.open( "some-output.dat" ) do |output|
        reader.each do |rec|
            output.write(rec.to_json)if rec['id'].start_with?("NCCU")
        end
    end
end
```

## CLI

After installing the gem, you can run `argot help` to see the available commands.  The 'validate' commands are described more fully below, but if you want to see what 'flattened' and 'flattend and suffixed' Argot look like you can run `argot flatten` or `argot suffix`, respectively, on raw Argot output.  

### Inputs and Outputs

Many commands accept input and output either from/to named files, or from STDIN and STDOUT, where omitting the `input` argument (or using the `-` shortcut) will read from STDIN, while omitting the output argument will output to STDOUT.

e.g 

    $ argot flatten < argot-notflat.json > argot-flat.json    

and

    $ argot flatten argot-notflat.json argot-flat.json    

are equivalent, but you can also do something like:

    $ my_argot_maker_that_ouputs_to_stdout | argot flatten | jq 

to avoid creating intermediate files.

If you want to read from STDIN but output to a named file, use `-` as the first argument, e.g. 

    $ my_argot_maker_that_writes_to_stdout | argot flatten - flattened.json

## Validation

    $ argot validate [input] [output]

Runs basic quality checks on the records in `input`, writing records that pass to `output`, and error messages to STDERR.  This lets you use `argot validate` as a filter, e.g.

    $ argot validate my_argot.json valid_argot.json

will result in only valid documents in `valid_argot.json`.  Note that if you use the `--all` switch (see below) the output is documents that are flattened,
suffixed, and Solr-valid, which are not suitable for ingest.  There is currently no support for retaining the original Argot in this mode.

If you just want to run the checks and not have the 'good' records appear in output, add the `-q` or `--quiet` option.

To run a full check against Argot output generated from `marc-to-argot` to the Solr documents as they are generated by `trln-ingest` application, you can run
`validate` with the `--all` or `-a` switch, which is an alias for the 
`full_validate` command.

## Documentation

To build the documentation, I suggest YARD.  

    $ gem install yard
    $ gem install redcarpet # may need a different markdown parser under jruby
    $ yard

This will create files in `doc/`

## Dependencies (Gems)

All Platforms:

 * [`traject`](https://github.com/traject/traject)

### MRI

 * [`yajl-ruby`](https://github.com/brianmario/yajl-ruby) -- JSON support
 
To support this, you'll need the `yajl` system package installed.

### JRuby

 * `jar-dependencies` 

Also uses `noggit`, the Java-based JSON parser from Solr, to process JSON;
import and use should be handled for you automatically.